name: Release Candidate

on:
  push:
    tags:
      - 'rc-*'
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (optional for manual dispatch)'
        required: false

jobs:
  build-and-validate:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    env:
      NODE_ENV: production
      CI: true
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10.11.0
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - name: Validate required release env names
        run: |
          test -n "${{ secrets.RC_DATABASE_URL }}" || (echo "Missing RC_DATABASE_URL" && exit 1)
          test -n "${{ secrets.RC_GCS_BUCKET }}" || (echo "Missing RC_GCS_BUCKET" && exit 1)
      - run: pnpm build
      - run: pnpm --filter @repo/db migrate -- --dry-run || true
      - name: Build release metadata
        run: |
          mkdir -p .release
          echo "ref=${GITHUB_REF}" > .release/metadata.txt
          echo "sha=${GITHUB_SHA}" >> .release/metadata.txt
          echo "created_at=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .release/metadata.txt
      - uses: actions/upload-artifact@v4
        with:
          name: release-candidate-${{ github.sha }}
          path: |
            .release/metadata.txt
            apps/api/dist
            apps/worker/dist
            apps/web/.next
